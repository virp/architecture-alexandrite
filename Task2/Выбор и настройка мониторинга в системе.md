### Мотивация

С учётом текущего и прогнозируемого роста объёма заказов регулярно возникает необходимость управлять трафиком и масштабировать сервисы, на которые приходится основная нагрузка. Если сервис не успевает обрабатывать входящие запросы, они начинают скапливаться в очереди, а в худшем случае - теряются, что, вероятно, уже имеет место. Корректно настроенный мониторинг позволяет своевременно выявлять перегрузки ресурсов, ограничивать поток запросов и затем масштабировать сервисы, испытывающие повышенную нагрузку.

### Потенциальные узкие места для мониторинга

**Internet Shop, Shop API** - нагрузка возрастает при одновременном редактировании сложных 3D-моделей большим количеством пользователей в часы пик.

**Message Queue** - в периоды высокой активности клиентов очередь может быстро заполняться, а разгружаться только в непиковые периоды. Важно не допустить ситуации, при которой клиентские запросы блокируют обработку сообщений от MES, мешая работе операторов.

**MES и связанные топики Message Queue** - количество операторов фиксировано, а производительность их работы прогнозируема, поэтому нагрузка поддаётся оценке. Однако любые расчёты могут оказаться неточными, поэтому поток запросов к MES и от MES требуется регулярно мониторить.

**База данных и файловое хранилище** - мониторинг этих компонентов понадобится, если будет выявлено узкое место и потребуется локализация причин.

**CRM** - согласно текущему описанию проблем, узких мест здесь не наблюдается, поэтому мониторинг можно минимизировать.

### Выбор подхода к мониторингу

**Internet Shop, Shop API**

Метод RED (Rate, Errors, Duration): количество запросов, длительность обработки, число активных пользователей.

**Message Queue**

Метод четырёх золотых сигналов: задержки, скорость обработки, заполненность очередей, ошибки.

**MES**

Комбинация RED (операции и пользователи) и USE (использование процессора, памяти).

**База данных и файловое хранилище**

Метод USE: загрузка CPU, I/O, использование ресурсов.

Планируется два уровня мониторинга:

- **Диагностический** - расширенный набор метрик, активируется при поиске проблем.

- **Базовый** - постоянный мониторинг минимально необходимого набора параметров.

### Выбор метрик

**Internet Shop, Shop API**

- Number of requests (RPS) for internet shop API
- Number of requests (RPS) per user
- Response time (latency) for shop API
- Number of HTTP 500 for shop API

**Message Queue**

- Перцентили задержек в очередях и API
- Number of dead-letter-exchange letters in RabbitMQ
- Number of messages in flight in RabbitMQ
- Response time (latency) for MES API
- Response time (latency) for CRM API

**MES**

- Number of requests (RPS) for MES API
- Number of requests (RPS) per user
- Memory utilisation for MES API
- CPU % for MES API
- Kilobytes received for MES API
- Kilobytes sent for MES API

**База данных и файловое хранилище**

- Size of S3 storage
- Size of shop DB instance
- Size of MES DB instance
- Response time (latency) of shop DB
- Response time (latency) of MES DB
- Response time (latency) of S3 storage

### План действий

1. Настроить мониторинг в диагностическом режиме на основе полного набора метрик для выявления узких мест и ошибок, приводящих к потере данных.
2. Настроить масштабирование сервисов, не справляющихся с нагрузкой, а при необходимости - и кэширование БД.
3. Перейти к базовому режиму мониторинга, сохранив:
   - Метрики из раздела 2 (Message Queue).
   - CPU % for MES API.
   - Метрики задержек из раздела 4 (БД и S3).

Доработать Shop API, реализовав фильтрацию данных на уровне запросов к БД.

### Показатели насыщенности

В базовом режиме должны контролироваться следующие параметры:

**Message Queue**

- Number of dead-letter-exchange letters in RabbitMQ
- Number of messages in flight in RabbitMQ

При превышении порогов необходимо включить диагностический мониторинг и трейсинг для локализации причин переполнения очередей.

**API задержки**

- Response time (latency) for MES API
- Response time (latency) for CRM API

При превышении значений следует проанализировать дополнительные метрики и, при недостатке данных, включить трейсинг реализации API.

**Нагрузка на вычислительные и хранилищные ресурсы**

- CPU % for MES API
- Response time (latency) of shop DB
- Response time (latency) of MES DB
- Response time (latency) of S3 storage
