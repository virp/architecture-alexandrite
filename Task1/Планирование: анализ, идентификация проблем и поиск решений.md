# Анализ схемы и описания системы

### Внешние проблемы

Компания "Александрит" ежемесячно фиксирует прирост примерно на 100 заказов. После внедрения механизма автоматического создания заказов в CRM через сообщения из очереди MES поток заявок значительно увеличился. Однако одновременно выросло число жалоб: клиенты сообщают менеджерам, что не получают свои изделия в обещанные сроки - работа над заказами затягивается на месяцы вместо заявленных трёх недель.

Производство при этом не является узким местом - мощности позволяют обрабатывать текущий объём и выдержать двукратный рост.

На четвёртом месяце система приняла около 400 заказов.

Среднее время расчёта стоимости составляет 2–3 минуты. На месячный объём уходит около 1200 минут, то есть порядка 20 часов. Этот показатель пока не ограничивает производительность. Реальные сложности возникнут, если MES перестанет успевать обрабатывать ежедневный поток и очередь начнёт расти бесконтрольно.

Пороговая нагрузка оценивается как 20 заказов в час, или 14 400 заказов в месяц. При текущем приросте в 100 заказов в месяц достижение этого уровня займёт около 144 месяцев. Вероятность того, что текущий объём заказов через API превышает этот предел, мала.

**Вывод:** расчёт стоимости не является текущим узким местом. Просрочки возникают из-за потери данных на одном из этапов обработки заказов.

### Жалобы операторов

Операторы отмечают длительную загрузку первой страницы MES, где выводится список заказов по статусам. Ранее отображались все заказы, затем добавили фильтрацию по статусам и пагинацию, но это не улучшило ситуацию. Операторам важно быстро видеть самые новые заказы.

Для решения проблемы фильтрацию необходимо реализовать на уровне API с фильтрацией в запросах к БД и сортировкой по времени.

---

### Основные проблемы

1. Логическая ошибка, приводящая к потере заказа в процессе обработки.
2. Нерациональная реализация фильтрации заказов в пользовательском интерфейсе.

---

### Инициативы

- Настроить трейсинг и логирование смены статусов заказов для точного выявления точек потери данных.
- Ввести мониторинг очередей, загрузки ЦП и потребления памяти для фиксации перегрузок, которые могут приводить к пропаже заказов.
- Включить механизм Backpressure для сглаживания пиков нагрузки, вероятно связанных с потерей данных.
- Реализовать фильтрацию и сортировку заказов на уровне MES API, чтобы возвращать данные сразу в отфильтрованном и отсортированном виде, начиная с самых новых, с поддержкой пагинации.

---

### Приоритеты

1. Выявление точек перегрузки и потери данных с помощью трейсинга, логирования и мониторинга.
2. Применение Backpressure для предотвращения перегрузок.
3. Перенос фильтрации на серверную сторону.
4. Масштабирование компонентов, признанных узкими местами по итогам анализа.

**Первые три пункта - обязательные.**

---

### Целевая архитектура

Система должна обеспечивать непрерывный мониторинг нагрузки, автоматическое масштабирование компонентов, приближающихся к пороговым значениям, и оперативное расширение тех сервисов, которые становятся ограничивающими при росте объёмов.
